/*! string2regex - v0.0.1 - 2014-10-23
* Copyright (c) 2014 ; Licensed  */
angular.module("string2regex",["ui.bootstrap"]).value("String2RegexConfiguration",{groupColors:["#F5A9A9","#F3E2A9","#D0F5A9","#A9F5BC","#A9F5F2","#A9BCF5","#D0A9F5","#F5A9E1"],classInfo:{number:{display_button:!0,button_text:"Num",button_tooltip:"Number"},uppercase:{display_button:!0,button_text:"Up",button_tooltip:"Uppercase"},lowercase:{display_button:!0,button_text:"Low",button_tooltip:"Lowercase"},alphabet:{display_button:!0,button_text:"Alpha",button_tooltip:"Alphabet"},alphanumerical:{display_button:!0,button_text:"AlNum",button_tooltip:"Alphanumerical"},space:{display_button:!0,button_text:"Spac",button_tooltip:"Space"},nonspace:{display_button:!0,button_text:"NSpac",button_tooltip:"NonSpace"},symbol:{display_button:!0,button_text:"Sym",button_tooltip:"Symbol"},constant:{display_button:!0,button_text:"Con",button_tooltip:"Constant"},any:{display_button:!0,button_text:"Any",button_tooltip:"Any"}},characterClassFunction:function(a){var b=[];return a>="0"&&"9">=a&&b.push("number"),a>="a"&&"z">=a&&b.push("lowercase"),a>="A"&&"Z">=a&&b.push("uppercase"),(_.contains(b,"lowercase")||_.contains(b,"uppercase"))&&b.push("alphabet"),(_.contains(b,"alphabet")||_.contains(b,"number"))&&b.push("alphanumerical"),b.push(" "===a?"space":"nonspace"),_.contains(b,"alphanumerical")||_.contains(b,"space")||b.push("symbol"),b.push("constant"),b.push("any"),b},generateRegexPortion:function(a,b){var c={number:"[0-9]",lowercase:"[a-z]",uppercase:"[A-Z]",alphabet:"[a-zA-Z]",alphanumerical:"[a-zA-Z0-9]",space:"\\s",nonspace:"\\S",symbol:"[^a-zA-Z0-9]",any:"."};return void 0!==c[a]?c[a]:"constant"===a?(b.string+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1"):"any"===a?".":"ERROR unknown charClass "+a},defaultClass:"any"}).controller("String2RegexCtrl",["$scope","String2RegexConfiguration",function(a,b){function c(a){for(var b=l(a[0]),c=1;c<a.length;c++){var d=l(a[c]);b=_.intersection(d,b)}return b}function d(a){return angular.forEach(arguments,function(b){b!==a&&angular.forEach(b,function(b,c){if(void 0!==b)if(a[c]&&a[c].constructor&&a[c].constructor===Array){var e=a[c].length;b.length<e&&(e=b);for(var f=0;e>f;f++)d(a[c][f],b[f])}else a[c]&&a[c].constructor&&a[c].constructor===Object?d(a[c],b):a[c]=b})}),a}function e(a,b){if(void 0===b&&(b=0),a.length<=1)return[];for(var d=[],e=c(a),g=_.difference(l(a[0]),e),h=0,i="",j=1;j<a.length;j++){var k=(a[j],_.difference(l(a[j]),e));0===_.intersection(k,g).length?(i=a.substring(h,j),d.push(f(i,b)),g=k,h=j):g=_.intersection(k,g)}return 0===h?(console.log("Apparently same group"),[]):(i=a.substring(h,a.length),d.push(f(i,b)),d)}function f(b,d){void 0===d&&(d=0);var f={picked:!1,string:b,multiplier:"omore",multiplier_min:1,multiplier_max:10,multiplier_constant:1,getSize:function(){return this.string.length},getGroupColor:function(){return g(this.depth)},commonClass:c(b,d),depth:d,selectedClass:"",hasSelected:function(){if(""!==this.selectedClass)return!0;var a=_.find(this.childs,function(a){return a.hasSelected()});return void 0!==a},ensureSelection:function(a){if(_.any(this.childs,function(a){return a.hasSelected()})){void 0!==a&&_.extend(this,_.pick(a,"selectedClass","multiplier","multipler_constant","multiplier_min","multiplier_max")),""===this.selectedClass&&(this.selectedClass=m);var b=this;_.each(this.childs,function(a){a.ensureSelection(b)}),this.selectedClass=""}else""===this.selectedClass&&(void 0!==a&&_.extend(this,_.pick(a,"selectedClass","multiplier","multipler_constant","multiplier_min","multiplier_max")),""===this.selectedClass&&(this.selectedClass=m))},ensureNoSelection:function(){this.selectedClass="",_.each(this.childs,function(a){a.ensureNoSelection()})},select:function(b){this.ensureNoSelection(),this.selectedClass=b,"constant"==b&&(this.multiplier="constant",this.multiplier_constant=1),a.rootGroup.ensureSelection(),h()},generateRegexPartitions:function(){var a=[];return""===this.selectedClass?_.each(this.childs,function(b){a=a.concat(b.generateRegexPartitions())}):a.push({regex:n(this.selectedClass,this),group:this}),a},generateRegex:function(){var a="",b=this.generateRegexPartitions();if(0===b.length)return a;var c,d=[],e={regex:b[0].regex,list:[b[0]]};for(c=1;c<b.length;c++){var f=b[c];f.regex===e.regex?e.list.push(f):(d.push(e),e={regex:b[c].regex,list:[b[c]]})}for(d.push(e),c=0;c<d.length;c++){var g=d[c];_.some(g.list,function(a){return"omore"==a.group.multiplier})?a+=g.regex+"+":_.some(g.list,function(a){return"zmore"==a.group.multiplier})?a+=g.regex+".":_.each(g.list,function(b){"constant"==b.group.multiplier?a+=1==b.group.multiplier_constant?g.regex:g.regex+"{"+b.group.multiplier_constant+"}":"optional"==b.group.multiplier?a+=g.regex+"?":"range"==b.group.multiplier&&(a+=g.regex+"{"+b.group.multiplier_min+","+b.group.multiplier_max+"}")})}return j.startAnchor&&(a="^"+a),j.endAnchor&&(a+="$"),a},preserveSettingFromOldGroup:function(a){function b(a,b){return _.intersection(a.commonClass,b.commonClass).length==a.commonClass.length}var c=this;_.each(["selectedClass","multiplier","multiplier_min","multiplier_max","multiplier_constant"],function(b){c[b]=a[b]});for(var d=i(a.childs,this.childs,b),e=0,f=0;f<this.childs.length&&!(e>=d.length);f++)b(this.childs[f],d[e])&&(this.childs[f].preserveSettingFromOldGroup(d[e]),e++)},regenerateResult:function(){h()},childs:e(b,d+1)};return f}function g(a){return k[a%k.length]}function h(){a.holder.regex=a.rootGroup.generateRegex()}function i(a,b,c){var d,e,f=[],g=[],h=[];for(d=0;d<b.length;d++)h.push(0);for(d=0;d<a.length;d++)f.push(angular.copy(h)),g.push(angular.copy(h));for(d=0;d<a.length;d++)for(e=0;e<b.length;e++)0===d||0===e?c(a[d],b[e])?(f[d][e]=1,g[d][e]=1):0===d?g[d][e]=3:0===e&&(g[d][e]=2):c(a[d],b[e])?(f[d][e]=f[d-1][e-1]+1,g[d][e]=1):(f[d-1][e]>f[d][e]&&(f[d][e]=f[d-1][e],g[d][e]=2),f[d][e-1]>f[d][e]&&(f[d][e]=f[d][e-1],g[d][e]=3));var i=[];for(d=a.length-1,e=b.length-1;-1!=d&&-1!=e;){var j=g[d][e];if(1==j&&(i.push(a[d]),d--,e--),2==j&&d--,3==j&&e--,0===j)break}return i.reverse(),i}var j=a.holder;_.defaults(j,{sample:"",regex:"",startAnchor:!0,endAnchor:!0});var k=b.groupColors,l=_.memoize(b.characterClassFunction),m=b.defaultClass,n=b.generateRegexPortion;a.classInfo=b.classInfo,a.$watch("holder.sample",function(){var b=a.rootGroup;a.rootGroup=f(j.sample),a.rootGroup.preserveSettingFromOldGroup(b),a.rootGroup.ensureSelection(),h()}),a.$watch("holder.startAnchor",function(){h()}),a.$watch("holder.endAnchor",function(){h()}),a.$watch("holder.rootGroup",function(){void 0!==j.rootGroup&&d(a.rootGroup,j.rootGroup)}),a.$watch("holder.regex",function(){j.rootGroup=JSON.parse(JSON.stringify(a.rootGroup))}),a.rootGroup=f(j.sample),a.rootGroup.ensureSelection(),h(),a.getCharacterClass=l,a.findLCS=i,a.getCommonCharacterClass=c,a.generateChildGroups=e,a.generateGroup=f,a.regenerateResult=h,a.getColorForDepth=g}]).controller("String2RegexGroupEditorCtrl",["$scope","group","$modalInstance","String2RegexConfiguration",function(a,b,c,d){this.close=function(){b.regenerateResult(),c.close()},this.group=b,a.group=b,a.classInfo=d.classInfo}]).directive("string2regex",function(){return{scope:{holder:"=string2regex"},controller:"String2RegexCtrl",link:function(){},templateUrl:"string2regex-template.html"}}).directive("string2regexGroup",["RecursionHelper","$modal",function(a,b){return{scope:{group:"=string2regexGroup"},controller:function(a,c){a.classInfo=c.classInfo,a.openEditor=function(a){b.open({templateUrl:"String2RegexGroupEditor.html",controller:"String2RegexGroupEditorCtrl",controllerAs:"editor",resolve:{group:function(){return a}}})}},link:function(){},compile:function(b){return a.compile(b)},templateUrl:"string2regex-template-group.html"}}]).factory("RecursionHelper",["$compile",function(a){return{compile:function(b,c){angular.isFunction(c)&&(c={post:c});var d,e=b.contents().remove();return{pre:c&&c.pre?c.pre:null,post:function(b,f){d||(d=a(e)),d(b,function(a){f.append(a)}),c&&c.post&&c.post.apply(null,arguments)}}}}}]).directive("ngMin",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){function e(a){return angular.isUndefined(a)||""===a||null===a||a!==a}a.$watch(c.ngMin,function(){d.$setViewValue(d.$viewValue)});var f=function(b){var f=a.$eval(c.ngMin)||0;return!e(b)&&f>b?void d.$setValidity("ngMin",!1):(d.$setValidity("ngMin",!0),b)};d.$parsers.push(f),d.$formatters.push(f)}}}).directive("ngMax",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){function e(a){return angular.isUndefined(a)||""===a||null===a||a!==a}a.$watch(c.ngMax,function(){d.$setViewValue(d.$viewValue)});var f=function(b){var f=a.$eval(c.ngMax)||1/0;return!e(b)&&b>f?void d.$setValidity("ngMax",!1):(d.$setValidity("ngMax",!0),b)};d.$parsers.push(f),d.$formatters.push(f)}}});
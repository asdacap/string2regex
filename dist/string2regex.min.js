/*! string2regex - v0.0.1 - 2014-10-25
* Copyright (c) 2014 ; Licensed  */
angular.module("string2regex",["ui.bootstrap","string2regex.template"]).value("String2RegexConfiguration",{groupColors:["#F5A9A9","#F3E2A9","#D0F5A9","#A9F5BC","#A9F5F2","#A9BCF5","#D0A9F5","#F5A9E1"],classInfo:{number:{display_button:!0,button_text:"Num",button_tooltip:"Number"},uppercase:{display_button:!0,button_text:"Up",button_tooltip:"Uppercase"},lowercase:{display_button:!0,button_text:"Low",button_tooltip:"Lowercase"},alphabet:{display_button:!0,button_text:"Alpha",button_tooltip:"Alphabet"},alphanumerical:{display_button:!0,button_text:"AlNum",button_tooltip:"Alphanumerical"},space:{display_button:!0,button_text:"Spac",button_tooltip:"Space"},nonspace:{display_button:!0,button_text:"NSpac",button_tooltip:"NonSpace"},symbol:{display_button:!0,button_text:"Sym",button_tooltip:"Symbol"},constant:{display_button:!0,button_text:"Con",button_tooltip:"Constant"},any:{display_button:!0,button_text:"Any",button_tooltip:"Any"}},characterClassFunction:function(a){var b=[];return a>="0"&&"9">=a&&b.push("number"),a>="a"&&"z">=a&&b.push("lowercase"),a>="A"&&"Z">=a&&b.push("uppercase"),(_.contains(b,"lowercase")||_.contains(b,"uppercase"))&&b.push("alphabet"),(_.contains(b,"alphabet")||_.contains(b,"number"))&&b.push("alphanumerical"),b.push(" "===a?"space":"nonspace"),_.contains(b,"alphanumerical")||_.contains(b,"space")||b.push("symbol"),b.push("constant"),b.push("any"),b},generateRegexPortion:function(a,b){var c={number:"[0-9]",lowercase:"[a-z]",uppercase:"[A-Z]",alphabet:"[a-zA-Z]",alphanumerical:"[a-zA-Z0-9]",space:"\\s",nonspace:"\\S",symbol:"[^a-zA-Z0-9]",any:"."};return void 0!==c[a]?c[a]:"constant"===a?(b.string+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1"):"any"===a?".":"ERROR unknown charClass "+a},defaultClass:"any"}).controller("String2RegexCtrl",["$scope","String2RegexConfiguration",function(a,b){function c(a){for(var b=n(a[0]),c=1;c<a.length;c++){var d=n(a[c]);b=_.intersection(d,b)}return b}function d(a,b){if(void 0===b&&(b=0),a.length<=1)return[];for(var d=[],f=c(a),g=_.difference(n(a[0]),f),h=0,i="",j=1;j<a.length;j++){var k=(a[j],_.difference(n(a[j]),f));0===_.intersection(k,g).length?(i=a.substring(h,j),d.push(e(i,b)),g=k,h=j):g=_.intersection(k,g)}return 0===h?(console.log("Apparently same group"),[]):(i=a.substring(h,a.length),d.push(e(i,b)),d)}function e(b,e){void 0===e&&(e=0);var g={string:b,multiplier:"omore",multiplier_min:1,multiplier_max:10,multiplier_constant:1,do_capture:!1,capture_name:"",commonClass:c(b,e),depth:e,selectedClass:"",getSize:function(){return this.string.length},getGroupColor:function(){return f(this.depth)},hasSelected:function(){if(""!==this.selectedClass)return!0;var a=_.find(this.childs,function(a){return a.hasSelected()});return void 0!==a},ensureSelection:function(a){if(_.any(this.childs,function(a){return a.hasSelected()})){void 0!==a&&_.extend(this,_.pick(a,"selectedClass","multiplier","multipler_constant","multiplier_min","multiplier_max")),""===this.selectedClass&&(this.selectedClass=o);var b=this;_.each(this.childs,function(a){a.ensureSelection(b)}),this.selectedClass=""}else""===this.selectedClass&&(void 0!==a&&_.extend(this,_.pick(a,"selectedClass","multiplier","multipler_constant","multiplier_min","multiplier_max")),""===this.selectedClass&&(this.selectedClass=o))},ensureNoSelection:function(){this.selectedClass="",_.each(this.childs,function(a){a.ensureNoSelection()})},select:function(b){""!==b&&(this.ensureNoSelection(),this.selectedClass=b,"constant"==b&&(this.multiplier="constant",this.multiplier_constant=1),a.rootGroup.ensureSelection(),h())},generateRegexPartitions:function(){var a=[];return""===this.selectedClass?_.each(this.childs,function(b){a=a.concat(b.generateRegexPartitions())}):a.push({regex:p(this.selectedClass,this),group:this}),a},generateGroupedRegexPartitions:function(){var a,b=this.generateRegexPartitions(),c=[],d={regex:b[0].regex,do_capture:b[0].group.do_capture,capture_name:b[0].group.capture_name,list:[b[0]]};for(a=1;a<b.length;a++){var e=b[a];e.regex!==d.regex||d.do_capture||e.group.do_capture?(c.push(d),d={regex:b[a].regex,do_capture:b[a].group.do_capture,capture_name:b[a].group.capture_name,list:[b[a]]}):d.list.push(e)}return c.push(d),c},generateTaggedRegex:function(){var a,b={items:[]},c=this.generateGroupedRegexPartitions();if(0===c.length)return b;for(a=0;a<c.length;a++){var d=c[a],e={items:[]};e.do_capture=d.do_capture,_.some(d.list,function(a){return"omore"==a.group.multiplier})?e.items.push({expression:d.regex,multiplier:"+"}):_.some(d.list,function(a){return"zmore"==a.group.multiplier})?e.items.push({expression:d.regex,multiplier:"."}):_.each(d.list,function(a){"constant"==a.group.multiplier?e.items.push(1==a.group.multiplier_constant?{expression:d.regex,multiplier:""}:{expression:d.regex,multiplier:"{"+a.group.multiplier_constant+"}"}):"optional"==a.group.multiplier?e.items.push({expression:d.regex,multiplier:"?"}):"range"==a.group.multiplier&&e.items.push({expression:d.regex,multiplier:"{"+a.group.multiplier_min+","+a.group.multiplier_max+"}"})}),b.items.push(e)}return b.startAnchor=l.startAnchor,b.endAnchor=l.endAnchor,b},convertTaggedRegexToString:function(a){var b="";a.startAnchor&&(b+="^"),a.do_capture&&(b+="(");var c=this;return _.each(a.items,function(a){b+=void 0!==a.items?c.convertTaggedRegexToString(a):a.expression+a.multiplier}),a.do_capture&&(b+=")"),a.endAnchor&&(b+="$"),b},generateRegex:function(){var a=this.generateTaggedRegex();return this.convertTaggedRegexToString(a)},preserveSettingFromOldGroup:function(a){function b(a,b){return _.intersection(a.commonClass,b.commonClass).length==a.commonClass.length}var c=this;_.each(r,function(b){c[b]=a[b]});for(var d=i(a.childs,this.childs,b),e=0,f=0;f<this.childs.length&&!(e>=d.length);f++)b(this.childs[f],d[e])&&(this.childs[f].preserveSettingFromOldGroup(d[e]),e++)},regenerateResult:function(){h()},childs:d(b,e+1)};return g}function f(a){return m[a%m.length]}function g(){var b=a.rootGroup.generateGroupedRegexPartitions();return _.chain(b).filter(function(a){return a.do_capture}).map(function(a){return a.capture_name}).value()}function h(){a.holder.taggedregex=a.rootGroup.generateTaggedRegex(),a.holder.regex=a.rootGroup.generateRegex()}function i(a,b,c){var d,e,f=[],g=[],h=[];for(d=0;d<b.length;d++)h.push(0);for(d=0;d<a.length;d++)f.push(angular.copy(h)),g.push(angular.copy(h));for(d=0;d<a.length;d++)for(e=0;e<b.length;e++)0===d||0===e?c(a[d],b[e])?(f[d][e]=1,g[d][e]=1):0===d?g[d][e]=3:0===e&&(g[d][e]=2):c(a[d],b[e])?(f[d][e]=f[d-1][e-1]+1,g[d][e]=1):(f[d-1][e]>f[d][e]&&(f[d][e]=f[d-1][e],g[d][e]=2),f[d][e-1]>f[d][e]&&(f[d][e]=f[d][e-1],g[d][e]=3));var i=[];for(d=a.length-1,e=b.length-1;-1!=d&&-1!=e;){var j=g[d][e];if(1==j&&(i.push(a[d]),d--,e--),2==j&&d--,3==j&&e--,0===j)break}return i.reverse(),i}function j(a,b){if(b.string!=a.string||a.childs.length!=b.childs.length)return void console.warn("Serialized group string mismatch!");_.each(q,function(c){b[c]=a[c]});for(var c=0;c<a.childs.length;c++)j(a.childs[c],b.childs[c])}function k(a){var b={};return _.each(q,function(c){b[c]=a[c]}),b.string=a.string,b.childs=_.map(a.childs,function(a){return k(a)}),b}var l=a.holder;_.defaults(l,{sample:"",regex:"",startAnchor:!0,endAnchor:!0});var m=b.groupColors,n=_.memoize(b.characterClassFunction),o=b.defaultClass,p=b.generateRegexPortion,q=["multiplier","multiplier_min","multiplier_max","multiplier_constant","do_capture","capture_name","selectedClass"],r=_.difference(q,["do_capture","capture_name"]);a.classInfo=b.classInfo,a.$watch("holder.sample",function(){var b=a.rootGroup;a.rootGroup=e(l.sample),a.rootGroup.preserveSettingFromOldGroup(b),a.rootGroup.ensureSelection(),h()}),a.$watch("holder.startAnchor",function(){h()}),a.$watch("holder.endAnchor",function(){h()}),a.$watch("holder.rootGroup",function(){void 0!==l.rootGroup&&(j(l.rootGroup,a.rootGroup),h())}),a.$watch("rootGroup",function(){l.captureNames=g(),l.rootGroup=k(a.rootGroup)},!0),a.rootGroup=e(l.sample),a.rootGroup.ensureSelection(),h(),a.serializeGroup=k,a.applySerializedGroupData=j,a.getCharacterClass=n,a.findLCS=i,a.getCommonCharacterClass=c,a.generateChildGroups=d,a.generateGroup=e,a.regenerateResult=h,a.getColorForDepth=f}]).controller("String2RegexGroupEditorCtrl",["$scope","group","$modalInstance","String2RegexConfiguration",function(a,b,c,d){var e=["multiplier","multiplier_min","multiplier_max","multiplier_constant","do_capture","capture_name","selectedClass"],f={};_.each(e,function(a){f[a]=b[a]}),this.save=function(){return a.mainform.$valid?(_.each(e,function(a){b[a]=f[a]}),b.select(f.selectedClass),b.regenerateResult(),void c.close()):void a.mainform.$setDirty()},this.close=function(){c.close()},this.group=f,a.group=f,a.origroup=b,a.classInfo=d.classInfo}]).directive("string2regex",function(){return{scope:{holder:"=string2regex"},controller:"String2RegexCtrl",link:function(){},templateUrl:"string2regex.tpl.html"}}).directive("string2regexGroup",["RecursionHelper","$modal",function(a,b){return{scope:{group:"=string2regexGroup"},controller:function(a,c){a.classInfo=c.classInfo,a.openEditor=function(a){b.open({templateUrl:"string2regex-groupeditor.tpl.html",controller:"String2RegexGroupEditorCtrl",controllerAs:"editor",resolve:{group:function(){return a}}})}},link:function(){},compile:function(b){return a.compile(b)},templateUrl:"string2regex-group.tpl.html"}}]).directive("string2regexPrettyregex",["RecursionHelper",function(a){return{scope:{tagged_regex:"=string2regexPrettyregex"},templateUrl:"string2regex-prettyregex.tpl.html",controller:function(a){a._=_},compile:function(b){return a.compile(b)}}}]).directive("string2regexPrettyregexGroup",["RecursionHelper",function(a){return{scope:{tagged_regex:"=string2regexPrettyregexGroup"},templateUrl:"string2regex-prettyregex-group.tpl.html",controller:function(a){a._=_},compile:function(b){return a.compile(b)}}}]).factory("RecursionHelper",["$compile",function(a){return{compile:function(b,c){angular.isFunction(c)&&(c={post:c});var d,e=b.contents().remove();return{pre:c&&c.pre?c.pre:null,post:function(b,f){d||(d=a(e)),d(b,function(a){f.append(a)}),c&&c.post&&c.post.apply(null,arguments)}}}}}]).directive("ngMin",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){function e(a){return angular.isUndefined(a)||""===a||null===a||a!==a}a.$watch(c.ngMin,function(){d.$setViewValue(d.$viewValue)});var f=function(b){var f=a.$eval(c.ngMin)||0;return!e(b)&&f>b?void d.$setValidity("ngMin",!1):(d.$setValidity("ngMin",!0),b)};d.$parsers.push(f),d.$formatters.push(f)}}}).directive("ngMax",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){function e(a){return angular.isUndefined(a)||""===a||null===a||a!==a}a.$watch(c.ngMax,function(){d.$setViewValue(d.$viewValue)});var f=function(b){var f=a.$eval(c.ngMax)||1/0;return!e(b)&&b>f?void d.$setValidity("ngMax",!1):(d.$setValidity("ngMax",!0),b)};d.$parsers.push(f),d.$formatters.push(f)}}}),angular.module("string2regex.template",["string2regex-group.tpl.html","string2regex-groupeditor.tpl.html","string2regex-prettyregex-group.tpl.html","string2regex-prettyregex.tpl.html","string2regex.tpl.html"]),angular.module("string2regex-group.tpl.html",[]).run(["$templateCache",function(a){a.put("string2regex-group.tpl.html",'<table ng-if="group !== undefined" class="group-table" style="background-color: {{ group.getGroupColor()}}">\n      <tbody>\n        <tr ng-if="group.childs.length == 0">\n          <td colspan="{{ group.string.length }}">\n            <div class="char-block"><span>{{ group.string }}</span></div>\n          </td>\n        </tr>\n        <tr ng-if="group.childs.length>=1">\n          <td ng-repeat="child in group.childs" colspan="{{ child.string.length }}">\n            <div string2regex-group="child" />\n          </td>\n        </tr>\n        <tr>\n          <td colspan="{{ group.string.length }}">\n            <div ng-repeat="class in group.commonClass" ng-if="classInfo[class].display_button || class == group.selectedClass" ng-class=" class == group.selectedClass ? [\'class-icon\',\'selected\',\'btn\',\'btn-xs\',\'btn-primary\'] : [\'class-icon\',\'btn\',\'btn-xs\',\'btn-default\'] " ng-click="group.select(class)" title="{{classInfo[class].button_tooltip}}">\n              {{ classInfo[class].button_text }}\n            </div>\n            <div class="btn btn-xs btn-default" ng-click="openEditor(group)"><span class="glyphicon glyphicon-cog" /></div>\n          </td>\n        </tr>\n      </tbody>\n    </table>\n')}]),angular.module("string2regex-groupeditor.tpl.html",[]).run(["$templateCache",function(a){a.put("string2regex-groupeditor.tpl.html",'<div class="modal-header">\n      <h3 class="modal-title">Group Options</h3>\n    </div>\n      <form name=\'mainform\' ng-submit="editor.save()">\n    <div class="modal-body">\n      <label>String:</label> <pre>{{ origroup.string }}</pre>\n        <div class="form-group">\n          <label>Available Class: </label><br />\n          <span ng-repeat="class in origroup.commonClass">\n            <span ng-class=" class == group.selectedClass ? [\'class-icon\',\'selected\',\'btn\',\'btn-sm\',\'btn-primary\'] : [\'class-icon\',\'btn\',\'btn-sm\',\'btn-default\'] " ng-click=" group.selectedClass = class " title="{{classInfo[class].button_tooltip}}">\n              {{ classInfo[class].button_text }}\n            </span>\n          </span>\n        </div>\n\n        <div class="row">\n          <div class="col-xs-4">\n            <div class="form-group">\n              <label>Multiplier: </label>\n              <select ng-model="group.multiplier" class="form-control" required>\n                <option value="constant">Constant</option>\n                <option value="range">Range</option>\n                <option value="omore">One or more (+)</option>\n                <option value="zmore">Zero or more (*)</option>\n                <option value="optional">Optional one (?)</option>\n              </select>\n            </div>\n          </div>\n          <div ng-if="group.multiplier == \'constant\'">\n            <div class="form-group col-xs-8">\n              <label> Multiplier value: </label>\n              <input type="number" class="form-control" ng-model="group.multiplier_constant" min="1" ng-required="group.multiplier == \'constant\'"></input>\n            </div>\n          </div>\n          <div ng-if="group.multiplier == \'range\'">\n            <div class="form-group col-xs-4">\n              <label> Multiplier Min: </label>\n              <input type="number" class="form-control" ng-model="group.multiplier_min" min="1" ng-max="{{group.multiplier_max}}" ng-required="group.multiplier == \'range\'"></input>\n            </div>\n            <div class="form-group col-xs-4">\n              <label> Multiplier Max: </label>\n              <input type="number" class="form-control" ng-model="group.multiplier_max" min="{{group.multiplier_min}}" ng-min="{{group.multiplier_min}}" ng-required="group.multiplier == \'range\'"></input>\n            </div>\n          </div>\n        </div>\n\n        <div class="checkbox">\n          <label>\n            <input type="checkbox" ng-model="group.do_capture"/> Capture Component\n          </label>\n        </div>\n        <div ng-if="group.do_capture">\n          <label> Capture Name: </label>\n          <input type="text" class="form-control" ng-model="group.capture_name" ng-required="group.do_capture"></input>\n        </div>\n\n        <div class="clearfix" />\n\n    </div>\n    <div class="modal-footer">\n      <div ng-class="\'btn btn-default\'" ng-click="editor.close()">Close</div>\n      <button ng-class="\'btn btn-primary\'">Save</button>\n    </div>\n      </form>\n')}]),angular.module("string2regex-prettyregex-group.tpl.html",[]).run(["$templateCache",function(a){a.put("string2regex-prettyregex-group.tpl.html",'<span ng-class="{ \'capture-group\':tagged_regex.do_capture }"><span ng-if="tagged_regex.do_capture" class="capture-parenthesis capture-start">(</span><span ng-repeat="part in tagged_regex.items"><span ng-if="part.items !== undefined"><span string2regex-prettyregex-group="part"></span></span><span ng-if="part.items === undefined"><span class="expression">{{ part.expression }}</span><span class="multiplier">{{ part.multiplier }}</span></span></span><span ng-if="tagged_regex.do_capture" class="capture-parenthesis capture-end">)</span></span>\n')}]),angular.module("string2regex-prettyregex.tpl.html",[]).run(["$templateCache",function(a){a.put("string2regex-prettyregex.tpl.html",'<span class="string2regex-prettyregex">\n  <span ng-if="tagged_regex.startAnchor" class="start-anchor">^</span><span string2regex-prettyregex-group="tagged_regex"></span><span ng-if="tagged_regex.endAnchor" class="end-anchor">$</span>\n</span>\n')}]),angular.module("string2regex.tpl.html",[]).run(["$templateCache",function(a){a.put("string2regex.tpl.html",'<div class="string2regex">\n      <div class="string2regex-table">\n        <div string2regex-group="rootGroup" />\n      </div>\n    </div>\n')}]);
/*! string2regex - v0.0.1 - 2014-10-24
* Copyright (c) 2014 ; Licensed  */
angular.module("string2regex",["ui.bootstrap","string2regex.template"]).value("String2RegexConfiguration",{groupColors:["#F5A9A9","#F3E2A9","#D0F5A9","#A9F5BC","#A9F5F2","#A9BCF5","#D0A9F5","#F5A9E1"],classInfo:{number:{display_button:!0,button_text:"Num",button_tooltip:"Number"},uppercase:{display_button:!0,button_text:"Up",button_tooltip:"Uppercase"},lowercase:{display_button:!0,button_text:"Low",button_tooltip:"Lowercase"},alphabet:{display_button:!0,button_text:"Alpha",button_tooltip:"Alphabet"},alphanumerical:{display_button:!0,button_text:"AlNum",button_tooltip:"Alphanumerical"},space:{display_button:!0,button_text:"Spac",button_tooltip:"Space"},nonspace:{display_button:!0,button_text:"NSpac",button_tooltip:"NonSpace"},symbol:{display_button:!0,button_text:"Sym",button_tooltip:"Symbol"},constant:{display_button:!0,button_text:"Con",button_tooltip:"Constant"},any:{display_button:!0,button_text:"Any",button_tooltip:"Any"}},characterClassFunction:function(a){var b=[];return a>="0"&&"9">=a&&b.push("number"),a>="a"&&"z">=a&&b.push("lowercase"),a>="A"&&"Z">=a&&b.push("uppercase"),(_.contains(b,"lowercase")||_.contains(b,"uppercase"))&&b.push("alphabet"),(_.contains(b,"alphabet")||_.contains(b,"number"))&&b.push("alphanumerical"),b.push(" "===a?"space":"nonspace"),_.contains(b,"alphanumerical")||_.contains(b,"space")||b.push("symbol"),b.push("constant"),b.push("any"),b},generateRegexPortion:function(a,b){var c={number:"[0-9]",lowercase:"[a-z]",uppercase:"[A-Z]",alphabet:"[a-zA-Z]",alphanumerical:"[a-zA-Z0-9]",space:"\\s",nonspace:"\\S",symbol:"[^a-zA-Z0-9]",any:"."};return void 0!==c[a]?c[a]:"constant"===a?(b.string+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1"):"any"===a?".":"ERROR unknown charClass "+a},defaultClass:"any"}).controller("String2RegexCtrl",["$scope","String2RegexConfiguration",function(a,b){function c(a){for(var b=m(a[0]),c=1;c<a.length;c++){var d=m(a[c]);b=_.intersection(d,b)}return b}function d(a,b){if(void 0===b&&(b=0),a.length<=1)return[];for(var d=[],f=c(a),g=_.difference(m(a[0]),f),h=0,i="",j=1;j<a.length;j++){var k=(a[j],_.difference(m(a[j]),f));0===_.intersection(k,g).length?(i=a.substring(h,j),d.push(e(i,b)),g=k,h=j):g=_.intersection(k,g)}return 0===h?(console.log("Apparently same group"),[]):(i=a.substring(h,a.length),d.push(e(i,b)),d)}function e(b,e){void 0===e&&(e=0);var i={string:b,multiplier:"omore",multiplier_min:1,multiplier_max:10,multiplier_constant:1,do_capture:!1,commonClass:c(b,e),depth:e,selectedClass:"",getSize:function(){return this.string.length},getGroupColor:function(){return f(this.depth)},hasSelected:function(){if(""!==this.selectedClass)return!0;var a=_.find(this.childs,function(a){return a.hasSelected()});return void 0!==a},ensureSelection:function(a){if(_.any(this.childs,function(a){return a.hasSelected()})){void 0!==a&&_.extend(this,_.pick(a,"selectedClass","multiplier","multipler_constant","multiplier_min","multiplier_max")),""===this.selectedClass&&(this.selectedClass=n);var b=this;_.each(this.childs,function(a){a.ensureSelection(b)}),this.selectedClass=""}else""===this.selectedClass&&(void 0!==a&&_.extend(this,_.pick(a,"selectedClass","multiplier","multipler_constant","multiplier_min","multiplier_max")),""===this.selectedClass&&(this.selectedClass=n))},ensureNoSelection:function(){this.selectedClass="",_.each(this.childs,function(a){a.ensureNoSelection()})},select:function(b){this.ensureNoSelection(),this.selectedClass=b,"constant"==b&&(this.multiplier="constant",this.multiplier_constant=1),a.rootGroup.ensureSelection(),g()},generateRegexPartitions:function(){var a=[];return""===this.selectedClass?_.each(this.childs,function(b){a=a.concat(b.generateRegexPartitions())}):a.push({regex:o(this.selectedClass,this),group:this}),a},generateGroupedRegexPartitions:function(){var a,b=this.generateRegexPartitions(),c=[],d={regex:b[0].regex,do_capture:b[0].group.do_capture,list:[b[0]]};for(a=1;a<b.length;a++){var e=b[a];e.regex!==d.regex||d.do_capture?(c.push(d),d={regex:b[a].regex,do_capture:b[a].group.do_capture,list:[b[a]]}):d.list.push(e)}return c.push(d),c},generateRegex:function(){var a,b="",c=this.generateGroupedRegexPartitions();if(0===c.length)return b;for(a=0;a<c.length;a++){var d=c[a];d.do_capture&&(b+="("),_.some(d.list,function(a){return"omore"==a.group.multiplier})?b+=d.regex+"+":_.some(d.list,function(a){return"zmore"==a.group.multiplier})?b+=d.regex+".":_.each(d.list,function(a){"constant"==a.group.multiplier?b+=1==a.group.multiplier_constant?d.regex:d.regex+"{"+a.group.multiplier_constant+"}":"optional"==a.group.multiplier?b+=d.regex+"?":"range"==a.group.multiplier&&(b+=d.regex+"{"+a.group.multiplier_min+","+a.group.multiplier_max+"}")}),d.do_capture&&(b+=")")}return k.startAnchor&&(b="^"+b),k.endAnchor&&(b+="$"),b},preserveSettingFromOldGroup:function(a){function b(a,b){return _.intersection(a.commonClass,b.commonClass).length==a.commonClass.length}var c=this;_.each(q,function(b){c[b]=a[b]});for(var d=h(a.childs,this.childs,b),e=0,f=0;f<this.childs.length&&!(e>=d.length);f++)b(this.childs[f],d[e])&&(this.childs[f].preserveSettingFromOldGroup(d[e]),e++)},regenerateResult:function(){g()},childs:d(b,e+1)};return i}function f(a){return l[a%l.length]}function g(){a.holder.regex=a.rootGroup.generateRegex()}function h(a,b,c){var d,e,f=[],g=[],h=[];for(d=0;d<b.length;d++)h.push(0);for(d=0;d<a.length;d++)f.push(angular.copy(h)),g.push(angular.copy(h));for(d=0;d<a.length;d++)for(e=0;e<b.length;e++)0===d||0===e?c(a[d],b[e])?(f[d][e]=1,g[d][e]=1):0===d?g[d][e]=3:0===e&&(g[d][e]=2):c(a[d],b[e])?(f[d][e]=f[d-1][e-1]+1,g[d][e]=1):(f[d-1][e]>f[d][e]&&(f[d][e]=f[d-1][e],g[d][e]=2),f[d][e-1]>f[d][e]&&(f[d][e]=f[d][e-1],g[d][e]=3));var i=[];for(d=a.length-1,e=b.length-1;-1!=d&&-1!=e;){var j=g[d][e];if(1==j&&(i.push(a[d]),d--,e--),2==j&&d--,3==j&&e--,0===j)break}return i.reverse(),i}function i(a,b){if(b.string!=a.string||a.childs.length!=b.childs.length)return void console.warn("Serialized group string mismatch!");_.each(p,function(c){b[c]=a[c]});for(var c=0;c<a.childs.length;c++)i(a.childs[c],b.childs[c])}function j(a){var b={};return _.each(p,function(c){b[c]=a[c]}),b.string=a.string,b.childs=_.map(a.childs,function(a){return j(a)}),b}var k=a.holder;_.defaults(k,{sample:"",regex:"",startAnchor:!0,endAnchor:!0});var l=b.groupColors,m=_.memoize(b.characterClassFunction),n=b.defaultClass,o=b.generateRegexPortion,p=["multiplier","multiplier_min","multiplier_max","multiplier_constant","do_capture","selectedClass"],q=_.difference(p,["do_capture"]);a.classInfo=b.classInfo,a.$watch("holder.sample",function(){var b=a.rootGroup;a.rootGroup=e(k.sample),a.rootGroup.preserveSettingFromOldGroup(b),a.rootGroup.ensureSelection(),g()}),a.$watch("holder.startAnchor",function(){g()}),a.$watch("holder.endAnchor",function(){g()}),a.$watch("holder.rootGroup",function(){void 0!==k.rootGroup&&i(k.rootGroup,a.rootGroup)}),a.$watch("rootGroup",function(){k.rootGroup=j(a.rootGroup)},!0),a.rootGroup=e(k.sample),a.rootGroup.ensureSelection(),g(),a.serializeGroup=j,a.applySerializedGroupData=i,a.getCharacterClass=m,a.findLCS=h,a.getCommonCharacterClass=c,a.generateChildGroups=d,a.generateGroup=e,a.regenerateResult=g,a.getColorForDepth=f}]).controller("String2RegexGroupEditorCtrl",["$scope","group","$modalInstance","String2RegexConfiguration",function(a,b,c,d){this.close=function(){b.regenerateResult(),c.close()},this.group=b,a.group=b,a.classInfo=d.classInfo}]).directive("string2regex",function(){return{scope:{holder:"=string2regex"},controller:"String2RegexCtrl",link:function(){},templateUrl:"string2regex.tpl.html"}}).directive("string2regexGroup",["RecursionHelper","$modal",function(a,b){return{scope:{group:"=string2regexGroup"},controller:function(a,c){a.classInfo=c.classInfo,a.openEditor=function(a){b.open({templateUrl:"string2regex-groupeditor.tpl.html",controller:"String2RegexGroupEditorCtrl",controllerAs:"editor",resolve:{group:function(){return a}}})}},link:function(){},compile:function(b){return a.compile(b)},templateUrl:"string2regex-group.tpl.html"}}]).factory("RecursionHelper",["$compile",function(a){return{compile:function(b,c){angular.isFunction(c)&&(c={post:c});var d,e=b.contents().remove();return{pre:c&&c.pre?c.pre:null,post:function(b,f){d||(d=a(e)),d(b,function(a){f.append(a)}),c&&c.post&&c.post.apply(null,arguments)}}}}}]).directive("ngMin",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){function e(a){return angular.isUndefined(a)||""===a||null===a||a!==a}a.$watch(c.ngMin,function(){d.$setViewValue(d.$viewValue)});var f=function(b){var f=a.$eval(c.ngMin)||0;return!e(b)&&f>b?void d.$setValidity("ngMin",!1):(d.$setValidity("ngMin",!0),b)};d.$parsers.push(f),d.$formatters.push(f)}}}).directive("ngMax",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){function e(a){return angular.isUndefined(a)||""===a||null===a||a!==a}a.$watch(c.ngMax,function(){d.$setViewValue(d.$viewValue)});var f=function(b){var f=a.$eval(c.ngMax)||1/0;return!e(b)&&b>f?void d.$setValidity("ngMax",!1):(d.$setValidity("ngMax",!0),b)};d.$parsers.push(f),d.$formatters.push(f)}}}),angular.module("string2regex.template",["string2regex-group.tpl.html","string2regex-groupeditor.tpl.html","string2regex.tpl.html"]),angular.module("string2regex-group.tpl.html",[]).run(["$templateCache",function(a){a.put("string2regex-group.tpl.html",'<table ng-if="group !== undefined" class="group-table" style="background-color: {{ group.getGroupColor()}}">\n      <tbody>\n        <tr ng-if="group.childs.length == 0">\n          <td colspan="{{ group.string.length }}">\n            <div class="char-block"><span>{{ group.string }}</span></div>\n          </td>\n        </tr>\n        <tr ng-if="group.childs.length>=1">\n          <td ng-repeat="child in group.childs" colspan="{{ child.string.length }}">\n            <div string2regex-group="child" />\n          </td>\n        </tr>\n        <tr>\n          <td colspan="{{ group.string.length }}">\n            <div ng-repeat="class in group.commonClass" ng-if="classInfo[class].display_button || class == group.selectedClass" ng-class=" class == group.selectedClass ? [\'class-icon\',\'selected\',\'btn\',\'btn-xs\',\'btn-primary\'] : [\'class-icon\',\'btn\',\'btn-xs\',\'btn-default\'] " ng-click="group.select(class)" title="{{classInfo[class].button_tooltip}}">\n              {{ classInfo[class].button_text }}\n            </div>\n            <div class="btn btn-xs btn-default" ng-click="openEditor(group)"><span class="glyphicon glyphicon-cog" /></div>\n          </td>\n        </tr>\n      </tbody>\n    </table>\n')}]),angular.module("string2regex-groupeditor.tpl.html",[]).run(["$templateCache",function(a){a.put("string2regex-groupeditor.tpl.html",'<div class="modal-header">\n      <h3 class="modal-title">Group Options</h3>\n    </div>\n    <div class="modal-body">\n      <label>String:</label> <pre>{{ group.string }}</pre>\n      <form name=\'mainform\'>\n        <div class="form-group">\n          <label>Available Class: </label><br />\n          <span ng-repeat="class in group.commonClass">\n            <span ng-class=" class == group.selectedClass ? [\'class-icon\',\'selected\',\'btn\',\'btn-sm\',\'btn-primary\'] : [\'class-icon\',\'btn\',\'btn-sm\',\'btn-default\'] " ng-click="group.select(class)" title="{{classInfo[class].button_tooltip}}">\n              {{ classInfo[class].button_text }}\n            </span>\n\n          </span>\n        </div>\n\n        <div class="row">\n          <div class="col-xs-4">\n            <div class="form-group">\n              <label>Multiplier: </label>\n              <select ng-model="group.multiplier" class="form-control" required>\n                <option value="constant">Constant</option>\n                <option value="range">Range</option>\n                <option value="omore">One or more (+)</option>\n                <option value="zmore">Zero or more (*)</option>\n                <option value="optional">Optional one (?)</option>\n              </select>\n            </div>\n          </div>\n          <div ng-if="group.multiplier == \'constant\'">\n            <div class="form-group col-xs-8">\n              <label> Multiplier value: </label>\n              <input type="number" class="form-control" ng-model="group.multiplier_constant" min="1" ng-required="group.multiplier == \'constant\'"></input>\n            </div>\n          </div>\n          <div ng-if="group.multiplier == \'range\'">\n            <div class="form-group col-xs-4">\n              <label> Multiplier Min: </label>\n              <input type="number" class="form-control" ng-model="group.multiplier_min" min="1" ng-max="{{group.multiplier_max}}" ng-required="group.multiplier == \'range\'"></input>\n            </div>\n            <div class="form-group col-xs-4">\n              <label> Multiplier Max: </label>\n              <input type="number" class="form-control" ng-model="group.multiplier_max" min="{{group.multiplier_min}}" ng-min="{{group.multiplier_min}}" ng-required="group.multiplier == \'range\'"></input>\n            </div>\n          </div>\n        </div>\n\n        <div class="checkbox">\n          <label>\n            <input type="checkbox" ng-model="group.do_capture"/> Capture Component\n          </label>\n        </div>\n\n        <div class="clearfix" />\n\n      </form>\n    </div>\n    <div class="modal-footer">\n      <div ng-class="\'btn btn-primary \'+(mainform.$valid ? \'\' : \'disabled\')" ng-click="mainform.$valid && editor.close()">Close</div>\n    </div>\n')}]),angular.module("string2regex.tpl.html",[]).run(["$templateCache",function(a){a.put("string2regex.tpl.html",'<div class="string2regex">\n      <div class="string2regex-table">\n        <div string2regex-group="rootGroup" />\n      </div>\n    </div>\n')}]);